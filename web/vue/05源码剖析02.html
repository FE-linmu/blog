<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>05源码剖析02 | 林慕的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="记录分享前端技术">
    <link rel="preload" href="/blog/assets/css/0.styles.fa7169f5.css" as="style"><link rel="preload" href="/blog/assets/js/app.5357dcc8.js" as="script"><link rel="preload" href="/blog/assets/js/2.ef134f65.js" as="script"><link rel="preload" href="/blog/assets/js/11.aadf7bb5.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.8198d6ab.js"><link rel="prefetch" href="/blog/assets/js/12.db363c5e.js"><link rel="prefetch" href="/blog/assets/js/13.afd82ec4.js"><link rel="prefetch" href="/blog/assets/js/14.56b0e56b.js"><link rel="prefetch" href="/blog/assets/js/15.86b8cdae.js"><link rel="prefetch" href="/blog/assets/js/16.a5e31507.js"><link rel="prefetch" href="/blog/assets/js/17.3d7007d4.js"><link rel="prefetch" href="/blog/assets/js/3.3ae9385c.js"><link rel="prefetch" href="/blog/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/blog/assets/js/5.f8be39f3.js"><link rel="prefetch" href="/blog/assets/js/6.61a92354.js"><link rel="prefetch" href="/blog/assets/js/7.3388c26e.js"><link rel="prefetch" href="/blog/assets/js/8.51f06735.js"><link rel="prefetch" href="/blog/assets/js/9.fee2630d.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.fa7169f5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">林慕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/web/vue/01组件化实战.html" class="nav-link">
  Web全栈架构师
</a></div><div class="nav-item"><a href="https://github.com/bei-yang/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/web/vue/01组件化实战.html" class="nav-link">
  Web全栈架构师
</a></div><div class="nav-item"><a href="https://github.com/bei-yang/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web/vue/01组件化实战.html" class="sidebar-link">01组件化实战</a></li><li><a href="/blog/web/vue/02全家桶（Vue-router&amp;&amp;Vuex）源码实现.html" class="sidebar-link">02全家桶（Vue-router&amp;&amp;Vuex）源码实现</a></li><li><a href="/blog/web/vue/03Vue基础版实现.html" class="sidebar-link">03Vue基础版实现</a></li><li><a href="/blog/web/vue/04源码剖析01.html" class="sidebar-link">04Vue源码剖析01</a></li><li><a href="/blog/web/vue/05源码剖析02.html" class="active sidebar-link">05源码剖析02</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web/vue/05源码剖析02.html#异步更新队列" class="sidebar-link">异步更新队列</a></li><li class="sidebar-sub-header"><a href="/blog/web/vue/05源码剖析02.html#虚拟-dom" class="sidebar-link">虚拟 DOM</a></li><li class="sidebar-sub-header"><a href="/blog/web/vue/05源码剖析02.html#patch" class="sidebar-link">patch</a></li><li class="sidebar-sub-header"><a href="/blog/web/vue/05源码剖析02.html#总结-思考" class="sidebar-link">总结&amp;&amp;思考</a></li></ul></li><li><a href="/blog/web/vue/06源码剖析03.html" class="sidebar-link">06源码剖析03</a></li><li><a href="/blog/web/vue/07服务端渲染SSR.html" class="sidebar-link">07服务端渲染SSR</a></li><li><a href="/blog/web/vue/08Vue+TS实践.html" class="sidebar-link">08Vue+TS实践</a></li><li><a href="/blog/web/vue/09项目最佳实践.html" class="sidebar-link">09项目最佳实践</a></li><li><a href="/blog/web/vue/10Vue3初探+响应式原理剖析.html" class="sidebar-link">10Vue3初探+响应式原理剖析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_05源码剖析02"><a href="#_05源码剖析02" class="header-anchor">#</a> 05源码剖析02</h1> <h2 id="异步更新队列"><a href="#异步更新队列" class="header-anchor">#</a> 异步更新队列</h2> <p>Vue 高效的秘诀是一套批量、异步的更新策略</p> <h3 id="概念解释"><a href="#概念解释" class="header-anchor">#</a> 概念解释</h3> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-cdd1ecd30fe8c5ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <ul><li><p>事件循环 Event Loop：浏览器为了协调事件处理、脚本执行、网络请求和渲染等任务而制定的工作机制。</p></li> <li><p>宏任务 Task：代表一个个离散的、独立的工作单元。<strong>浏览器完成一个宏任务，在下一个宏任务执行开始前，会对页面进行重新渲染</strong>。主要包括创建文档对象、解析 HTML、执行主线 JS 代码以及各种事件如页面加载、输入、网络事件和定时器等。</p></li> <li><p>微任务：微任务是更小的任务，是在当前宏任务执行结束后立即执行的任务。<strong>如果存在微任务，浏览器会清空微任务之后再重新渲染</strong>。微任务的例子有 Promise 回调函数、DOM 变化等。</p></li></ul> <p><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/?utm_source=html5weekly" target="_blank" rel="noopener noreferrer">体验一下<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="vue-中的具体实现"><a href="#vue-中的具体实现" class="header-anchor">#</a> Vue 中的具体实现</h3> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-cd2465838d0fe3e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <ul><li><p>异步：只要侦听到数据变化，Vue 将开启一个队列，并缓冲在同一事件循环中发生的所有数据变更。</p></li> <li><p>批量：如果同一个 Watcher 被多次触发，只会被推入到队列中一次。去重对于避免不必要的计算和 DOM 操作是非常重要的。然后，在下一个的事件循环 tick 中，Vue 刷新队列执行实际工作。</p></li> <li><p>异步策略：Vue 在内部对异步队列尝试使用原生的 Promise.then、MutationObserver 或 setTmmediate，如果执行环境都不支持，则会采用 setTimeout 代替。</p></li></ul> <h4 id="update-core-observer-watcher-js"><a href="#update-core-observer-watcher-js" class="header-anchor">#</a> update() core\observer\watcher.js</h4> <p>dep.notify() 之后 watcher 执行更新，执行入队操作</p> <h4 id="queuewatcher-watcher-core-observer-scheduler-js"><a href="#queuewatcher-watcher-core-observer-scheduler-js" class="header-anchor">#</a> queueWatcher(watcher) core\observer\scheduler.js</h4> <p>执行 watcher 入队操作</p> <h4 id="nexttick-flushschedulerqueue-core-util-next-tick-js"><a href="#nexttick-flushschedulerqueue-core-util-next-tick-js" class="header-anchor">#</a> nextTick(flushSchedulerQueue) core\util\next-tick.js</h4> <p>nextTick 按照特定异步策略执行队列操作</p> <p>测试代码：<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/05%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9002/examples/test/03-timerFunc.html" target="_blank" rel="noopener noreferrer">03-timerFunc.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>watcher 中 update 执行三次，但 run 仅执行一次，且数值变化对 dom 的影响也不是立竿见影的。</p> <blockquote><p>可以研究下相关 API：vm.$nextTick(cb)</p></blockquote> <p>$nextTick 把传入回调函数放入 callbacks 队尾</p> <p>$nextTick 原理执行顺序：</p> <p>Promise==&gt;MutationObserver==&gt;SetImmediate==&gt;setTimeout</p> <h2 id="虚拟-dom"><a href="#虚拟-dom" class="header-anchor">#</a> 虚拟 DOM</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>虚拟 DOM（Vitual DOM）是对 DOM 的 JS 抽象表示，他们是 JS 对象，能够描述 DOM 结构和关系。应用的各种状态变化会作用于虚拟 DOM，最终映射到 DOM 上。</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-f3e94c770edfd3f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <h3 id="体验虚拟-dom"><a href="#体验虚拟-dom" class="header-anchor">#</a> 体验虚拟 DOM</h3> <p>Vue 中虚拟 dom 基于 snabbdom 实现，安装 snabbdom 并体验</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--安装并引⼊snabbdom--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>../../node_modules/snabbdom/dist/snabbdom.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 之前编写的响应式函数</span>
    <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          val <span class="token operator">=</span> newVal
          <span class="token comment">// 通知更新</span>
          <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 导⼊patch的⼯⼚init，h是产⽣vnode的⼯⼚</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> init<span class="token punctuation">,</span> h <span class="token punctuation">}</span> <span class="token operator">=</span> snabbdom
    <span class="token comment">// 获取patch函数</span>
    <span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">// 上次vnode，由patch()返回</span>
    <span class="token keyword">let</span> vnode<span class="token punctuation">;</span>
    <span class="token comment">// 更新函数，将数据操作转换为dom操作，返回新vnode</span>
    <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化，没有上次vnode，传⼊宿主元素和vnode</span>
        vnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新，传⼊新旧vnode对⽐并做更新</span>
        vnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 渲染函数，返回vnode描述dom结构</span>
    <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 数据</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// 定义响应式</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token comment">// 赋⼀个⽇期作为初始值</span>
    obj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 定时改变数据，更新函数会重新执⾏</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h3> <ol><li>虚拟 DOM 轻量、快速：当它们发生变化时通过新旧虚拟 DOM 比对可以得到最小 DOM 操作量，配合异步更新策略减少刷新频率，从而提升性能</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>跨平台：将虚拟 dom 更新转换为不同运行时特殊操作实现跨平台</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;../../node_modules/snabbdom/dist/snabbdom-style.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token comment">// 增加style模块</span>
    <span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>snabbdom_style<span class="token punctuation">.</span>default<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 添加节点样式描述</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>style<span class="token operator">:</span> <span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><ol start="3"><li>兼容性：还可以加入兼容性代码增强操作的兼容性</li></ol> <h3 id="必要性"><a href="#必要性" class="header-anchor">#</a> 必要性</h3> <p>vue 1.0 中有细粒度的数据变化侦测，它是不需要虚拟 DOM 的，但是细粒度造成了大量开销，这对于大型项目来说是不可接受的。因此，vue 2.0 选择了中等粒度的解决方案，每⼀个组件⼀个 watcher 实例，这样状态变化时只能通知到组件，再通过引入虚拟 DOM 去进行比对和渲染。</p> <h3 id="整体流程"><a href="#整体流程" class="header-anchor">#</a> 整体流程</h3> <h4 id="mountcomponent-core-instance-lifecycle-js"><a href="#mountcomponent-core-instance-lifecycle-js" class="header-anchor">#</a> mountComponent() core/instance/lifecycle.js</h4> <p>渲染、更新组件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义更新函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 实际调⽤是在lifeCycleMixin中定义的_update和renderMixin中定义的_render</span>
  vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="render-core-instance-render-js"><a href="#render-core-instance-render-js" class="header-anchor">#</a> _render core/instance/render.js</h4> <p>生成虚拟 dom</p> <h4 id="update-core-instance-lifecycle-js"><a href="#update-core-instance-lifecycle-js" class="header-anchor">#</a> _update core\instance\lifecycle.js</h4> <p>update 负责更新 dom，转换 vnode 为 dom</p> <h4 id="patch-platforms-web-runtime-index-js"><a href="#patch-platforms-web-runtime-index-js" class="header-anchor">#</a> <strong>patch</strong>() platforms/web/runtime/index.js</h4> <p>__patch__是在平台特有代码中指定的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__patch__ <span class="token operator">=</span> inBrowser <span class="token operator">?</span> patch <span class="token operator">:</span> noop
</code></pre></div><p>测试代码，<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/05%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9002/examples/test/04-vdom.html" target="_blank" rel="noopener noreferrer">examples\test\04-vdom.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="patch"><a href="#patch" class="header-anchor">#</a> patch</h2> <h3 id="patch-获取"><a href="#patch-获取" class="header-anchor">#</a> patch 获取</h3> <p>patch 是 createPatchFunction 的返回值，传递 nodeOps 和 modules 是 web 平台特别实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> patch<span class="token operator">:</span> Function <span class="token operator">=</span> <span class="token function">createPatchFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nodeOps<span class="token punctuation">,</span> modules <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="platforms-web-runtime-node-ops-js"><a href="#platforms-web-runtime-node-ops-js" class="header-anchor">#</a> platforms\web\runtime\node-ops.js</h4> <p>定义各种原生 dom 基础操作方法</p> <h4 id="platforms-web-runtime-modules-index-js"><a href="#platforms-web-runtime-modules-index-js" class="header-anchor">#</a> platforms\web\runtime\modules\index.js</h4> <p>modules 定义了属性更新实现</p> <p>watcher.run() =&gt; componentUpdate() =&gt; render() =&gt; update() =&gt; patch()</p> <h3 id="patch-实现"><a href="#patch-实现" class="header-anchor">#</a> patch 实现</h3> <h4 id="patch-core-vdom-patch-js"><a href="#patch-core-vdom-patch-js" class="header-anchor">#</a> patch core\vdom\patch.js</h4> <p>首先进行树级别比较，可能有三种情况：增删改。</p> <ul><li><p>new VNode 不存在就删；</p></li> <li><p>old VNode 不存在就增；</p></li> <li><p>都存在就执行 diff 执行更新</p></li></ul> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-8798dd6c76983bd8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <h4 id="patchvnode"><a href="#patchvnode" class="header-anchor">#</a> patchVnode</h4> <p>比较两个 VNode，包括三种类型操作：属性更新、文本更新、子节点更新</p> <p>具体规则如下：</p> <ol><li><p>新老节点均有 children 子节点，则对子节点进行 diff 操作，调用 updateChildren</p></li> <li><p>如果新节点有子节点点而老节点没有子节点，先清空老节点的文本内容，然后为其新增子节点</p></li> <li><p>当新节点没有子节点而老节点有子节点的时候，则移除该节点的所有子节点</p></li> <li><p>当新老节点都无子节点的时候，只是文本的替换</p></li></ol> <p>测试，<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/05%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9002/examples/test/04-vdom.html" target="_blank" rel="noopener noreferrer">04-vdom.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-5bc233de45c5c6fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// patchVnode过程分解</span>
<span class="token comment">// 1.div#demo updateChildren</span>
<span class="token comment">// 2.h1 updateChildren</span>
<span class="token comment">// 3.text ⽂本相同跳过</span>
<span class="token comment">// 4.p updateChildren</span>
<span class="token comment">// 5.text setTextContent</span>
</code></pre></div><h4 id="updatechildren"><a href="#updatechildren" class="header-anchor">#</a> updateChildren</h4> <p>updateChildren 主要作用是用⼀种较高效的方式比对新旧两个 VNode 的 children 得出最小操作补丁。执行⼀个双循环是传统方式，Vue 中针对 web 场景特点做了特别的算法优化，我们看图说话：</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-99fb5e3e05f4f456.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>在新老两组 VNode 节点的左右头尾两侧都有⼀个变量标记，在遍历过程中这几个变量都会向中间靠拢。</p> <p>当oldStartIdx &gt; oldEndIdx或者newStartIdx &gt; newEndIdx时结束循环。</p> <p>下面是遍历规则：</p> <p>首先，oldStartVnode、oldEndVnode与newStartVnode、newEndVnode 两两交叉比较，共有4种比较方法。</p> <p>当 oldStartVnode 和 newStartVnode 或者 oldEndVnode 和 newEndVnode 满足 sameVnode，直接将该 VNode 节点进行 patchVnode 即可，不需再遍历就完成了⼀次循环。如下图：</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-aa89d92cbb763ba9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>如果 oldStartVnode 与 newEndVnode 满足 sameVnode。说明 oldStartVnode 已经跑到了 oldEndVnode 后面去了，进行 patchVnode 的同时还需要将真实 DOM 节点移动到 oldEndVnode 的后面。</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-c13d46aaed728d50.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>如果 oldEndVnode 与 newStartVnode 满足 sameVnode，说明 oldEndVnode 跑到了 oldStartVnode 的前面，进行 patchVnode 的同时要将 oldEndVnode 对应 DOM 移动到 oldStartVnode 对应 DOM 的前面。</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-67e52f6166d810d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>如果以上情况均不符合，则在 old VNode 中找与 newStartVnode 相同的节点，若存在执行 patchVnode，同时将 elmToMove 移动到 oldStartIdx 对应的 DOM 的前面。</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-73f84e8be34aaf19.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>当然也有可能 newStartVnode 在 old VNode 节点中找不到⼀致的 sameVnode，这个时候会调用 createElm 创建⼀个新的 DOM 节点。</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-c871363dbe9a3e3f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>至此循环结束，但是我们还需要处理剩下的节点。</p> <p>当结束时 oldStartIdx &gt; oldEndIdx，这个时候旧的 VNode 节点已经遍历完了，但是新的节点还没有。说明了新的 VNode 节点实际上比老的 VNode 节点多，需要将剩下的 VNode 对应的 DOM 插入到真实 DOM 中，此时调用 addVnodes（批量调用 createElm 接口）。</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-918b57ae1d909232.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>但是，当结束时 newStartIdx &gt; newEndIdx 时，说明新的 VNode 节点已经遍历完了，但是老的节点还有剩余，需要从文档中将老的节点删除。</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-cbfe0626e553bc29.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <h2 id="总结-思考"><a href="#总结-思考" class="header-anchor">#</a> 总结&amp;&amp;思考</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#demo'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token string">'ready~~'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 批量、异步</span>
    <span class="token comment">// 每次赋值，watcher入队</span>
    <span class="token comment">// $nextTick()把传入回调函数放入callbacks队尾</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1:'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2:'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3:'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 异步行为，此时内容没变</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1.innerHTML:'</span> <span class="token operator">+</span> p1<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span> <span class="token comment">// ready~~</span>

    <span class="token comment">// [callbacks, fn]</span>
    <span class="token comment">// Promise.resolve().then(() =&gt; {</span>
    <span class="token comment">//     console.log('promise, p1.innerHTML:' + p1.innerHTML)</span>
    <span class="token comment">// })</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里才是最新的值</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1.innerHTML:'</span> <span class="token operator">+</span> p1<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>面试官：在 Vue 里面执行 mounted 里面的内容，输出结果如何？</p> <p>面试官：如果把 $nextTick 放在中间位置呢？</p> <p>面试官：如果把 $nextTick 放在最上面位置呢？</p> <p>面试官：如果再加上 Promise 呢？</p> <p>如果...</p> <p>如果没有如果...</p> <p>附思维导图：</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-14decba51144b788.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/web/vue/04源码剖析01.html" class="prev">
        04Vue源码剖析01
      </a></span> <span class="next"><a href="/blog/web/vue/06源码剖析03.html">
        06源码剖析03
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.5357dcc8.js" defer></script><script src="/blog/assets/js/2.ef134f65.js" defer></script><script src="/blog/assets/js/11.aadf7bb5.js" defer></script>
  </body>
</html>
