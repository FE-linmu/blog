<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>02全家桶（Vue-router&amp;&amp;Vuex）源码实现 | 林慕的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="记录分享前端技术">
    <link rel="preload" href="/blog/assets/css/0.styles.fa7169f5.css" as="style"><link rel="preload" href="/blog/assets/js/app.5357dcc8.js" as="script"><link rel="preload" href="/blog/assets/js/2.ef134f65.js" as="script"><link rel="preload" href="/blog/assets/js/8.51f06735.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.8198d6ab.js"><link rel="prefetch" href="/blog/assets/js/11.aadf7bb5.js"><link rel="prefetch" href="/blog/assets/js/12.db363c5e.js"><link rel="prefetch" href="/blog/assets/js/13.afd82ec4.js"><link rel="prefetch" href="/blog/assets/js/14.56b0e56b.js"><link rel="prefetch" href="/blog/assets/js/15.86b8cdae.js"><link rel="prefetch" href="/blog/assets/js/16.a5e31507.js"><link rel="prefetch" href="/blog/assets/js/17.3d7007d4.js"><link rel="prefetch" href="/blog/assets/js/3.3ae9385c.js"><link rel="prefetch" href="/blog/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/blog/assets/js/5.f8be39f3.js"><link rel="prefetch" href="/blog/assets/js/6.61a92354.js"><link rel="prefetch" href="/blog/assets/js/7.3388c26e.js"><link rel="prefetch" href="/blog/assets/js/9.fee2630d.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.fa7169f5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">林慕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/web/vue/01组件化实战.html" class="nav-link">
  Web全栈架构师
</a></div><div class="nav-item"><a href="https://github.com/bei-yang/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/web/vue/01组件化实战.html" class="nav-link">
  Web全栈架构师
</a></div><div class="nav-item"><a href="https://github.com/bei-yang/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web/vue/01组件化实战.html" class="sidebar-link">01组件化实战</a></li><li><a href="/blog/web/vue/02全家桶（Vue-router&amp;&amp;Vuex）源码实现.html" class="active sidebar-link">02全家桶（Vue-router&amp;&amp;Vuex）源码实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web/vue/02全家桶（Vue-router&amp;&amp;Vuex）源码实现.html#vue-router-源码实现" class="sidebar-link">Vue-Router 源码实现</a></li><li class="sidebar-sub-header"><a href="/blog/web/vue/02全家桶（Vue-router&amp;&amp;Vuex）源码实现.html#vuex-原理" class="sidebar-link">Vuex 原理</a></li></ul></li><li><a href="/blog/web/vue/03Vue基础版实现.html" class="sidebar-link">03Vue基础版实现</a></li><li><a href="/blog/web/vue/04源码剖析01.html" class="sidebar-link">04Vue源码剖析01</a></li><li><a href="/blog/web/vue/05源码剖析02.html" class="sidebar-link">05源码剖析02</a></li><li><a href="/blog/web/vue/06源码剖析03.html" class="sidebar-link">06源码剖析03</a></li><li><a href="/blog/web/vue/07服务端渲染SSR.html" class="sidebar-link">07服务端渲染SSR</a></li><li><a href="/blog/web/vue/08Vue+TS实践.html" class="sidebar-link">08Vue+TS实践</a></li><li><a href="/blog/web/vue/09项目最佳实践.html" class="sidebar-link">09项目最佳实践</a></li><li><a href="/blog/web/vue/10Vue3初探+响应式原理剖析.html" class="sidebar-link">10Vue3初探+响应式原理剖析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_02全家桶（vue-router-vuex）源码实现"><a href="#_02全家桶（vue-router-vuex）源码实现" class="header-anchor">#</a> 02全家桶（Vue-router&amp;&amp;Vuex）源码实现</h1> <p>此文章的<a href="https://www.processon.com/view/link/5e146d6be4b0da16bb15aa2a#map" target="_blank" rel="noopener noreferrer">思维导图<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Vue Router 是 <a href="https://cn.vuejs.org/" target="_blank" rel="noopener noreferrer">Vue.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 官方的路由管理器，它和 Vue.js 的核心深度集成，让构建单页面应用变得易如反掌。</p> <p>安装：</p> <div class="language-js extra-class"><pre class="language-js"><code>vue add router
</code></pre></div><p>核心步骤：</p> <ol><li><p>使用 vue-router 插件，router.js</p> <div class="language-vue extra-class"><pre class="language-vue"><code>import Route from 'vue-router'
Vue.use(Router)
</code></pre></div></li> <li><p>创建 Router 实例，router.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>在根组件上添加该实例，main.js</p> <div class="language-vue extra-class"><pre class="language-vue"><code>import router from './router'
new Vue({
  router
}).$mount('#app')
</code></pre></div></li> <li><p>添加路由视图，App.vue</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>导航</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>/about<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>About<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ol> <h2 id="vue-router-源码实现"><a href="#vue-router-源码实现" class="header-anchor">#</a> Vue-Router 源码实现</h2> <p>单页面应用程序中，URL 发生变化，不刷新并显示对应的视图内容</p> <p>需求分析</p> <ol><li><p>spa 点击链接不能出刷新页面</p> <ul><li><p>hash #xxx</p></li> <li><p>history api</p></li></ul></li> <li><p>事件 hashchange，通知 router-view 更新</p> <ul><li><p>利用 Vue 数据响应式</p></li> <li><p>制作一个响应式数据表示当前 URL，在 router-view 的 render 函数使用它</p></li></ul></li></ol> <p>任务</p> <ol><li><p>实现一个插件</p> <ul><li><p>实现 VueRouter 类</p></li> <li><p>实现 install 方法</p></li></ul></li> <li><p>实现两个全局组件</p> <ul><li><p>router-link</p></li> <li><p>router-view</p></li></ul></li></ol> <h3 id="创建-kvue-router-js"><a href="#创建-kvue-router-js" class="header-anchor">#</a> 创建 kvue-router.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 插件</span>

<span class="token keyword">let</span> KVue

<span class="token comment">// 1. 实现一个install方法</span>
<span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options

    <span class="token comment">// 响应式数据</span>
    <span class="token keyword">const</span> initial <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span>
    KVue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'current'</span><span class="token punctuation">,</span> initial<span class="token punctuation">)</span>

    <span class="token comment">// this.current = '/'</span>

    <span class="token comment">// 监听事件</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onHashChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onHashChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 缓存path和route映射关系</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>route<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> route
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">onHashChange</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 形参是Vue构造函数</span>
KVueRouter<span class="token punctuation">.</span><span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存构造函数（独立的包，不希望将vue也打包进去）</span>
  KVue <span class="token operator">=</span> Vue

  <span class="token comment">// 1. 挂载$router</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 全局混入，将来在组件实例化的时候才执行</span>
      <span class="token comment">// 此时Vue实例已经存在了</span>
      <span class="token comment">// this指的是组件实例</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 2. 实现两个全局组件</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      to<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        required<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// h是createElement函数</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// &lt;a href='#/xxx'&gt;&lt;/a&gt;</span>
      <span class="token comment">// h(tag,props,children)</span>
      <span class="token comment">// jsx语法也可以用</span>
      <span class="token comment">// return &lt;a href={'#' + this.to}&gt;{this.$slots.default}&lt;/a&gt;</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>
        <span class="token string">'a'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
            href<span class="token operator">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// rouetr-view 是一个容器</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-view'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. 获取路由器实例</span>
      <span class="token comment">// const routes = this.$router.$options.routes</span>
      <span class="token comment">// const current = this.$router.current</span>
      <span class="token comment">// const route = routes.find(route =&gt; route.path === current)</span>
      <span class="token comment">// const comp = route ? route.component : null</span>

      <span class="token keyword">const</span> <span class="token punctuation">{</span> routeMap<span class="token punctuation">,</span> current <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$router
      <span class="token keyword">const</span> comp <span class="token operator">=</span> routeMap<span class="token punctuation">[</span>current<span class="token punctuation">]</span> <span class="token operator">?</span> routeMap<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span>component <span class="token operator">:</span> <span class="token keyword">null</span>

      <span class="token comment">// 获取路由表 eg:'/'===home组件</span>
      <span class="token comment">// return h('div','view')</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> KVueRouter
</code></pre></div><h2 id="vuex-原理"><a href="#vuex-原理" class="header-anchor">#</a> Vuex 原理</h2> <p>Vuex 集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以可预测的方式发生变化。</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-1614a14df1d1c220.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Vuex"></p> <h3 id="整合-vuex"><a href="#整合-vuex" class="header-anchor">#</a> 整合 vuex</h3> <div class="language-js extra-class"><pre class="language-js"><code>vue add vuex
</code></pre></div><h3 id="核心概念"><a href="#核心概念" class="header-anchor">#</a> 核心概念</h3> <ul><li>state 状态、数据</li> <li>mutations 更改状态的函数</li> <li>actions 异步操作</li> <li>store 包含以上概念的容器</li></ul> <h3 id="状态-state"><a href="#状态-state" class="header-anchor">#</a> 状态 - state</h3> <h4 id="state保存应用状态"><a href="#state保存应用状态" class="header-anchor">#</a> state保存应用状态</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span> counter<span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="状态变更-mutations"><a href="#状态变更-mutations" class="header-anchor">#</a> 状态变更 - mutations</h4> <p>mutations用于修改状态，store.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mutations<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">add</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>counter<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="派生状态-getters"><a href="#派生状态-getters" class="header-anchor">#</a> 派生状态 - getters</h4> <p>从state派生出新状态，类似计算属性</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">doubleCounter</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 计算剩余数量</span>
      <span class="token keyword">return</span> state<span class="token punctuation">.</span>counter <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="动作-actions"><a href="#动作-actions" class="header-anchor">#</a> 动作 - actions</h4> <p>添加业务逻辑，类似于 controller</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">add</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>测试代码：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>$store.commit('add')<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>counter: {{$store.state.counter}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>$store.dispatch('add')<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>async counter: {{$store.state.counter}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>double：{{$store.getters.doubleCounter}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="原理解析"><a href="#原理解析" class="header-anchor">#</a> 原理解析</h3> <p>任务</p> <ol><li><p>实现⼀个插件：声明Store类，挂载$store</p></li> <li><p>Store具体实现：</p> <ul><li><p>创建响应式的 state，保存 mutations、actions 和 getters</p></li> <li><p>实现 commit 根据用户传入 type 执行对应 mutation</p></li> <li><p>实现 dispatch 根据用户传入 type 执行对应 action，同时传递上下文</p></li> <li><p>实现 getters，按照 getters 定义对 state 做派生</p></li></ul></li></ol> <p>代码实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> KVue

<span class="token comment">// 实现 Store 类</span>
<span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存 mutations</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations <span class="token operator">=</span> options<span class="token punctuation">.</span>mutations

    <span class="token comment">// 保存 actions</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_actions <span class="token operator">=</span> options<span class="token punctuation">.</span>actions

    <span class="token comment">// 绑定 this 到 store 实例</span>
    <span class="token comment">// 绑定 commit 上下⽂否则 action 中调⽤ commit 时可能出问题!!</span>
    <span class="token comment">// 同时也把 action 绑了，因为 action 可以互调</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> commit<span class="token punctuation">,</span> action <span class="token punctuation">}</span> <span class="token operator">=</span> store
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">commit</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">boundCommit</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">action</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">boundAction</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// getters</span>
    <span class="token comment">// 1. 遍历用户传入 getters 所有 key,动态赋值，其值应该是函数执行结果</span>
    <span class="token comment">// 2. 确保它是响应式的，Object.defineProperty(this.getters,key,{get(){}})</span>
    <span class="token comment">// 3. 缓存结果，可以利用 computed    </span>
    <span class="token keyword">let</span> computed <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    options<span class="token punctuation">.</span>getters <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleGetters</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> computed<span class="token punctuation">)</span>

    <span class="token comment">// 响应式的 state</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KVue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
        $$state<span class="token operator">:</span> options<span class="token punctuation">.</span>state
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      computed
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleGetters</span> <span class="token punctuation">(</span><span class="token parameter">getters<span class="token punctuation">,</span> computed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>getters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>getters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> getters<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getters<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> getters<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span>
        enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">state</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">state</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'请重新设置'</span> <span class="token operator">+</span> v <span class="token operator">+</span> <span class="token string">'的名称'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// commit(type,payload):执行 mutation，修改状态</span>
  <span class="token function">commit</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据 type 获取对应的 mutations</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'这是未知的 mutation 类型'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token function">entry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// dispatch(type,payload)</span>
  <span class="token function">dispatch</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'这是未知的 action 类型'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 实现插件</span>
<span class="token keyword">function</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  KVue <span class="token operator">=</span> Vue

  <span class="token comment">// 混入</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>store
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 此处导出的对象理解为 Vuex</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> Store<span class="token punctuation">,</span> install <span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/web/vue/01组件化实战.html" class="prev">
        01组件化实战
      </a></span> <span class="next"><a href="/blog/web/vue/03Vue基础版实现.html">
        03Vue基础版实现
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.5357dcc8.js" defer></script><script src="/blog/assets/js/2.ef134f65.js" defer></script><script src="/blog/assets/js/8.51f06735.js" defer></script>
  </body>
</html>
