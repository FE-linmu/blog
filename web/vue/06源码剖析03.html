<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>06源码剖析03 | 林慕的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="记录分享前端技术">
    <link rel="preload" href="/blog/assets/css/0.styles.fa7169f5.css" as="style"><link rel="preload" href="/blog/assets/js/app.5357dcc8.js" as="script"><link rel="preload" href="/blog/assets/js/2.ef134f65.js" as="script"><link rel="preload" href="/blog/assets/js/12.db363c5e.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.8198d6ab.js"><link rel="prefetch" href="/blog/assets/js/11.aadf7bb5.js"><link rel="prefetch" href="/blog/assets/js/13.afd82ec4.js"><link rel="prefetch" href="/blog/assets/js/14.56b0e56b.js"><link rel="prefetch" href="/blog/assets/js/15.86b8cdae.js"><link rel="prefetch" href="/blog/assets/js/16.a5e31507.js"><link rel="prefetch" href="/blog/assets/js/17.3d7007d4.js"><link rel="prefetch" href="/blog/assets/js/3.3ae9385c.js"><link rel="prefetch" href="/blog/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/blog/assets/js/5.f8be39f3.js"><link rel="prefetch" href="/blog/assets/js/6.61a92354.js"><link rel="prefetch" href="/blog/assets/js/7.3388c26e.js"><link rel="prefetch" href="/blog/assets/js/8.51f06735.js"><link rel="prefetch" href="/blog/assets/js/9.fee2630d.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.fa7169f5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">林慕的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/web/vue/01组件化实战.html" class="nav-link">
  Web全栈架构师
</a></div><div class="nav-item"><a href="https://github.com/bei-yang/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/web/vue/01组件化实战.html" class="nav-link">
  Web全栈架构师
</a></div><div class="nav-item"><a href="https://github.com/bei-yang/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web/vue/01组件化实战.html" class="sidebar-link">01组件化实战</a></li><li><a href="/blog/web/vue/02全家桶（Vue-router&amp;&amp;Vuex）源码实现.html" class="sidebar-link">02全家桶（Vue-router&amp;&amp;Vuex）源码实现</a></li><li><a href="/blog/web/vue/03Vue基础版实现.html" class="sidebar-link">03Vue基础版实现</a></li><li><a href="/blog/web/vue/04源码剖析01.html" class="sidebar-link">04Vue源码剖析01</a></li><li><a href="/blog/web/vue/05源码剖析02.html" class="sidebar-link">05源码剖析02</a></li><li><a href="/blog/web/vue/06源码剖析03.html" class="active sidebar-link">06源码剖析03</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web/vue/06源码剖析03.html#模板编译" class="sidebar-link">模板编译</a></li><li class="sidebar-sub-header"><a href="/blog/web/vue/06源码剖析03.html#组件化机制" class="sidebar-link">组件化机制</a></li><li class="sidebar-sub-header"><a href="/blog/web/vue/06源码剖析03.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/blog/web/vue/07服务端渲染SSR.html" class="sidebar-link">07服务端渲染SSR</a></li><li><a href="/blog/web/vue/08Vue+TS实践.html" class="sidebar-link">08Vue+TS实践</a></li><li><a href="/blog/web/vue/09项目最佳实践.html" class="sidebar-link">09项目最佳实践</a></li><li><a href="/blog/web/vue/10Vue3初探+响应式原理剖析.html" class="sidebar-link">10Vue3初探+响应式原理剖析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_06源码剖析03"><a href="#_06源码剖析03" class="header-anchor">#</a> 06源码剖析03</h1> <h2 id="模板编译"><a href="#模板编译" class="header-anchor">#</a> 模板编译</h2> <p>模板编译的主要目标是<strong>将模板（template）转为渲染函数（render）</strong></p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-6414db9de69c56a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="template==&gt;render"></p> <h3 id="模板编译必要性"><a href="#模板编译必要性" class="header-anchor">#</a> 模板编译必要性</h3> <p>Vue2.0 需要用到 Vnode 描述视图以及各种交互，手写显然不切实际，因此用户只需编写类似 HTML 代码的 Vue 模板，通过编译器将模板转换为可返回 Vnode 的 render 函数。</p> <h3 id="体验模板编译"><a href="#体验模板编译" class="header-anchor">#</a> 体验模板编译</h3> <p>带编译器的版本中，可以使用 template 或 el 的方式生命模板，<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/examples/test/06-1-compiler.html" target="_blank" rel="noopener noreferrer">测试 demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-vue extra-class"><pre class="language-vue"><code>(function anonymous (
  ) {
    with (this) {
      return _c('div', { attrs: { &quot;id&quot;: &quot;demo&quot; } }, [_c('h1', [_v(&quot;Vue模板编
    译&quot;)]),_v(&quot; &quot;),_c('p',[_v(_s(foo))]),_v(&quot; &quot;),_c('comp')],1)}
    })
</code></pre></div><p>输出结果大致如下：</p> <div class="language-vue extra-class"><pre class="language-vue"><code>(function anonymous () {
  with (this) {
    return _c('div', { attrs: { &quot;id&quot;: &quot;demo&quot; } }, [
      _c('h1', [_v(&quot;Vue模板编译&quot;)]),
      _v(&quot; &quot;), _c('p', [_v(_s(foo))]),
      _v(&quot; &quot;), _c('comp')], 1)
  }
})
</code></pre></div><ul><li><p>元素节点使用 createElement 创建，别名 _c</p></li> <li><p>本文节点使用 createTextVNode 创建，别名 _v</p></li> <li><p>表达式先使用 toString 格式化，别名 _s</p></li> <li><p>其他渲染 helpers：<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/src/core/instance/render-helpers/index.js" target="_blank" rel="noopener noreferrer">src\core\instance\render-helpers\index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <h3 id="整体流程"><a href="#整体流程" class="header-anchor">#</a> 整体流程</h3> <h4 id="compiletofunctions"><a href="#compiletofunctions" class="header-anchor">#</a> compileToFunctions</h4> <p>若指定 template 或 el 选项，则会执行编译，<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/src/platforms/web/entry-runtime-with-compiler.js" target="_blank" rel="noopener noreferrer">platforms\web\entry-runtime-with-compiler.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="编译过程"><a href="#编译过程" class="header-anchor">#</a> 编译过程</h4> <p>编译分为三步：解析、优化和生成，<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/src/compiler/index.js" target="_blank" rel="noopener noreferrer">src\compiler\index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/examples/test/06-1-compiler.html" target="_blank" rel="noopener noreferrer">测试 demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="模板编译过程"><a href="#模板编译过程" class="header-anchor">#</a> 模板编译过程</h3> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-7f1514c067ccb207.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>实现模板编译共有三个阶段：解析、优化和生成。</p> <h4 id="解析-parse"><a href="#解析-parse" class="header-anchor">#</a> 解析 - parse</h4> <p>解析器将模板解析为抽象语法树，基于 AST 可以做优化或者代码生成工作。</p> <p>调试查看得到的 AST，<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/src/compiler/parser/index.js" target="_blank" rel="noopener noreferrer">/src/compiler/parser/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，结构如下：</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-76ae1dca7ad50693.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>解析器内部分了 <strong>HTML 解析器、文本解析器和过滤解析器</strong>，最主要是 HTML 解析器。</p> <h4 id="优化-optimize"><a href="#优化-optimize" class="header-anchor">#</a> 优化 - optimize</h4> <p>优化器的作用是在 AST 中找出静态子树并打上标记。静态子树是在 AST 中永远不变的节点，如纯文本节点。</p> <p>标记静态子树的好处：</p> <ul><li><p>每次重新渲染，不需要为静态子树创建新节点；</p></li> <li><p>虚拟 DOM 中 patch 时，可以跳过静态子树。</p></li></ul> <p><a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/examples/test/06-2-compiler-optimize.html" target="_blank" rel="noopener noreferrer">测试 demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>代码实现，<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/src/compiler/optimizer.js" target="_blank" rel="noopener noreferrer">src/compiler/optimizer.js - optimize<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>标记结束</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-653ed33d2283fa92.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <h4 id="代码生成-generage"><a href="#代码生成-generage" class="header-anchor">#</a> 代码生成 - generage</h4> <p>将 AST 转换成渲染函数中的内容，即代码字符串。</p> <p>generate 方法生成渲染函数代码，<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/src/compiler/codegen/index.js" target="_blank" rel="noopener noreferrer">src/compiler/codegen/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>生成的 code：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('div',{attrs:{&quot;id&quot;:&quot;demo&quot;}},[
_c('h1',[_v(&quot;Vue.js测试&quot;)]),
_c('p',[_v(_s(foo))])
])</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><h3 id="典型指令的实现：v-if、v-for"><a href="#典型指令的实现：v-if、v-for" class="header-anchor">#</a> 典型指令的实现：v-if、v-for</h3> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-df269d6d7c2c700c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>着重观察几个结构性指令的解析过程。</p> <p>解析 v-if：<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/src/compiler/parser/index.js" target="_blank" rel="noopener noreferrer">parser/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>processIf 用于处理 v-if 解析：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">processIf</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> exp <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-if'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>if <span class="token operator">=</span> exp
    <span class="token function">addIfCondition</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      exp<span class="token operator">:</span> exp<span class="token punctuation">,</span>
      block<span class="token operator">:</span> el
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-else'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>else <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> elseif <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-else-if'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elseif<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>elseif <span class="token operator">=</span> elseif
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解析结果：</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-d35be5c22a212a1a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>代码生成，<a href="https://github.com/bei-yang/Front-end-architect/blob/324e49d5f095015a95fd8e804dbc17bddb10007f/Vue/04%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9001/vue-study-web20-source/src/compiler/codegen/index.js" target="_blank" rel="noopener noreferrer">codegen/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>genIfConditions 等用于生产条件语句相关代码。</p> <p>生成结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;with(this){return _c('div',{attrs:{&quot;</span>id<span class="token string">&quot;:&quot;</span>demo&quot;<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
<span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot;no title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span>&quot;
</code></pre></div><p>解析 v-for：<a href="https://github.com/bei-yang/Front-end-architect/blob/master/Vue/06%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9003/src/compiler/parser/index.js" target="_blank" rel="noopener noreferrer">parser/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>processFor 用于处理 v-for 指令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">processFor</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> exp
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exp <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-for'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">parseFor</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">extend</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid v-for expression: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        el<span class="token punctuation">.</span>rawAttrsMap<span class="token punctuation">[</span><span class="token string">'v-for'</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解析结果：v-for=&quot;item in items&quot;</p> <p>for:&quot;items&quot;</p> <p>alias:&quot;item&quot;</p> <p><img src="https://upload-images.jianshu.io/upload_images/15424855-87cb73a8f4a64f2d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p> <p>代码生成，<a href="https://github.com/bei-yang/Front-end-architect/blob/324e49d5f095015a95fd8e804dbc17bddb10007f/Vue/04%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9001/vue-study-web20-source/src/compiler/codegen/index.js" target="_blank" rel="noopener noreferrer">src\compiler\codegen\index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>genFor 用于生成响应代码。</p> <p>生成结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;with(this){return _c('div',{attrs:{&quot;</span>id<span class="token string">&quot;:&quot;</span>demo<span class="token string">&quot;}},[_m(0),_v(&quot;</span> &quot;<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token operator">?</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">_l</span><span class="token punctuation">(</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span>s<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'comp'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span>&quot;
</code></pre></div><p>v-if、v-for 这些指令只能在编译器阶段处理，如果我们要在 render 函数处理条件或循环只能使用 if 和 for。</p> <div class="language-vue extra-class"><pre class="language-vue"><code>Vue.component('comp', {
  props: ['foo'],
  render (h) { // 渲染内容跟foo的值挂钩，只能⽤if语句
    if (this.foo == 'foo') {
      return h('div', 'foo')
    }
    return h('div', 'bar')
  }
})
</code></pre></div><div class="language-vue extra-class"><pre class="language-vue"><code>(function anonymous (
) {
  with (this) {
    return _c('div', { attrs: { &quot;id&quot;: &quot;demo&quot; } }, [_m(0), _v(&quot; &quot;), (foo) ? _c('p',
      [_v(_s(foo))]) : _e(), _v(&quot; &quot;), _c('comp')], 1)
  }
})
</code></pre></div><h2 id="组件化机制"><a href="#组件化机制" class="header-anchor">#</a> 组件化机制</h2> <h3 id="组件声明：vue-component"><a href="#组件声明：vue-component" class="header-anchor">#</a> 组件声明：Vue.component()</h3> <p>initAssetRegisters(Vue) <a href="https://github.com/bei-yang/Front-end-architect/blob/324e49d5f095015a95fd8e804dbc17bddb10007f/Vue/04%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9001/vue-study-web20-source/src/core/global-api/assets.js" target="_blank" rel="noopener noreferrer">src/core/global-api/assets.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，组件注册使用 extend 方法将配置转换为构造函数并添加到 components 选项。</p> <h3 id="组件实例创建及挂载"><a href="#组件实例创建及挂载" class="header-anchor">#</a> 组件实例创建及挂载</h3> <p>观察生成的渲染函数：</p> <div class="language-vue extra-class"><pre class="language-vue"><code>&quot;with(this){return _c('div',{attrs:{&quot;id&quot;:&quot;demo&quot;}},[
  _c('h1', [_v(&quot;虚拟DOM&quot;)]), _v(&quot; &quot;),
  _c('p', [_v(_s(foo))]), _v(&quot; &quot;),
  _c('comp') // 对于组件的处理并⽆特殊之处
  ], 1)}&quot;
</code></pre></div><h3 id="整体流程-2"><a href="#整体流程-2" class="header-anchor">#</a> 整体流程</h3> <p>首先创建的是跟实例，首次 _render() 时，会得到整棵树的 Vnode 结构，其中自定义组件相关的主要有：</p> <p>整体流程：</p> <p>new Vue() =&gt; $mount() =&gt; vm._render(h) =&gt; createElement() =&gt; createComponent() =&gt; patch =&gt; createElm =&gt; createComponent()</p> <h4 id="createelement-src-core-vdom-create-element-js"><a href="#createelement-src-core-vdom-create-element-js" class="header-anchor">#</a> <a href="https://github.com/bei-yang/Front-end-architect/blob/324e49d5f095015a95fd8e804dbc17bddb10007f/Vue/04%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9001/vue-study-web20-source/src/core/vdom/create-element.js" target="_blank" rel="noopener noreferrer">_createElement - src\core\vdom\create-element.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h4> <p>_createElement 实际执行 Vnode 创建的函数，由于传入 tag 是非保留标签，因此判定为自定义组件通过 createComponent 去创建。</p> <h4 id="createcomponent-src-core-vdom-create-component-js"><a href="#createcomponent-src-core-vdom-create-component-js" class="header-anchor">#</a> <a href="https://github.com/bei-yang/Front-end-architect/blob/324e49d5f095015a95fd8e804dbc17bddb10007f/Vue/04%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9001/vue-study-web20-source/src/core/vdom/create-component.js" target="_blank" rel="noopener noreferrer">createComponent - src/core/vdom/create-component.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h4> <p>创建组件 Vnode，保存了上一步处理得到的组件构造函数，props，事件等</p> <h3 id="创建组件实例"><a href="#创建组件实例" class="header-anchor">#</a> 创建组件实例</h3> <p>根组件执行更新函数时，会递归创建子元素和子组件，入口 createElm。</p> <h4 id="createele-core-vdom-patch-js-line751"><a href="#createele-core-vdom-patch-js-line751" class="header-anchor">#</a> <a href="https://github.com/bei-yang/Front-end-architect/blob/324e49d5f095015a95fd8e804dbc17bddb10007f/Vue/04%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9001/vue-study-web20-source/src/core/vdom/patch.js" target="_blank" rel="noopener noreferrer">createEle() core/vdom/patch.js line751<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h4> <p>首次执行 _update() 时，patch() 会通过 createEle() 创建根元素，子元素创建研究从这里开始。</p> <h4 id="createcomponent-core-vdom-patch-js-line144"><a href="#createcomponent-core-vdom-patch-js-line144" class="header-anchor">#</a> <a href="https://github.com/bei-yang/Front-end-architect/blob/324e49d5f095015a95fd8e804dbc17bddb10007f/Vue/04%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%9001/vue-study-web20-source/src/core/vdom/patch.js" target="_blank" rel="noopener noreferrer">createComponent core/vdom/patch.js line144<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h4> <p>自定义组件创建：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 组件实例创建、挂载</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">i</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* hydrating */</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>componentInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 元素引⽤指定vnode.elm，元素属性创建等</span>
  <span class="token function">initComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
  <span class="token comment">// 插⼊到⽗元素</span>
  <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>isReactivated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reactivateComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>Vue源码学习使我们能够深入理解原理，解答很多开发中的疑惑，规避很多潜在的错误，写出更好的代码。学习大神的代码，能够学习编程思想，设计模式，训练基本功，提升内力。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/web/vue/05源码剖析02.html" class="prev">
        05源码剖析02
      </a></span> <span class="next"><a href="/blog/web/vue/07服务端渲染SSR.html">
        07服务端渲染SSR
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.5357dcc8.js" defer></script><script src="/blog/assets/js/2.ef134f65.js" defer></script><script src="/blog/assets/js/12.db363c5e.js" defer></script>
  </body>
</html>
